# azure-iot-location-monitoring\terraform\modules\databricks\main.tf

# Fetches the smallest available Databricks node type with local disk support
data "databricks_node_type" "smallest" {
  local_disk = true
}

# Fetches the latest long-term support (LTS) Spark version available on Databricks
data "databricks_spark_version" "latest_lts" {
  long_term_support = true
}

# Provisions a Databricks cluster using the LTS Spark version and smallest node type
resource "databricks_cluster" "iot_cluster" {
  cluster_name            = "iot-dbx-cluster"
  spark_version           = "16.4.x-scala2.12"
  node_type_id            = "Standard_DS3_v2"
  autotermination_minutes = 30
  num_workers             = 1

  library {
    maven {
      coordinates = "com.microsoft.azure:azure-eventhubs-spark_2.12:2.3.22"
    }
  }

  library {
    maven {
      coordinates = "com.azure.cosmos.spark:azure-cosmos-spark_3-5_2-12:4.37.2"
    }
  }
}

# Upload a Python notebook (notebook.py) to read from Event Hub and write to Cosmos DB.
resource "databricks_notebook" "iot_notebook" {
  path     = "/Shared/iot-location-notebook"
  language = "PYTHON"
  source   = "${path.module}/notebook.py"
}

# Create a Databricks job that executes the uploaded notebook on the specified cluster
resource "databricks_job" "iot_job" {
  name = "iot-dbx-job"

  task {
    task_key            = "simulate-iot"
    existing_cluster_id = databricks_cluster.iot_cluster.id

    notebook_task {
      notebook_path = databricks_notebook.iot_notebook.path
      base_parameters = {
        device_count                 = "100"
        # CRITICAL CHANGE: ONLY pass the Base64 encoded IoT Hub connection string
        # This variable's value comes from your root modules.tf
        eventhub_connection_string_base64 = var.eventhub_connection_string_base64

        # REMOVE THESE LINES FROM HERE (if present in your file),
        # as these widgets are no longer passed from modules.tf
        # and are not needed by the notebook in its correct form.
        # eventhub_connection_string   = var.eventhub_connection_string
        # eventhub_connection_string_plus_entity = var.eventhub_connection_string_plus_entity
        # eventhub_instance_name       = var.eventhub_instance_name

        cosmos_db_endpoint           = var.cosmos_db_endpoint
        cosmos_db_key                = var.cosmos_db_key
        cosmos_db_database           = var.cosmos_db_database
        cosmos_db_container          = var.cosmos_db_container
      }
    }
  }
}