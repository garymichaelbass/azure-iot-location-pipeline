- name: Terraform Apply with Lock Recovery
  run: |
    set -e

    echo "üöÄ Running terraform apply..."
    if terraform apply -auto-approve; then
      echo "‚úÖ Terraform apply succeeded."
    else
      echo "‚ö†Ô∏è Terraform apply failed. Checking for lock..."

      LOCK_ID=$(terraform apply -auto-approve 2>&1 | tee /tmp/tf_output.log | grep -oP 'ID:\s+\K[0-9a-fA-F-]+')
      
      if [[ -n "$LOCK_ID" ]]; then
        echo "üîì Found lock ID: $LOCK_ID. Attempting force unlock..."
        terraform force-unlock "$LOCK_ID"
        echo "üîÅ Retrying terraform apply..."
        terraform apply -auto-approve
      else
        echo "‚ùå No lock ID found. Failing the job."
        exit 1
      fi
    fi
  working-directory: ./terraform
  shell: bash
  env:
    TF_VAR_github_client_id: ${{ secrets.AZURE_CLIENT_ID }}
    TF_VAR_github_client_secret: ${{ secrets.AZURE_CLIENT_SECRET }}
    TF_VAR_github_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
    TF_VAR_github_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
    ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
    ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}