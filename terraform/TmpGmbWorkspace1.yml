from pyspark.sql.functions import when, lit

# Parse JSON and handle missing timestamps
json_df = raw_df.select(from_json(col("body").cast("string"), schema).alias("data")).select("data.*")

# Replace null timestamps with current time (or a default)
json_df = json_df.withColumn(
    "timestamp",
    when(col("timestamp").isNull(), lit(0)).otherwise(col("timestamp"))
)

# Add a unique ID field
json_df = json_df.withColumn("id", concat_ws("-", col("deviceId"), col("timestamp")))