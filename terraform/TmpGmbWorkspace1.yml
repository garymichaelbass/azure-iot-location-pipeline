- name: Set up Kubeconfig for AKS
  run: |
    mkdir -p ~/.kube
    echo "${{ steps.terraform_outputs.outputs.AKS_KUBECFG }}" | base64 -d > ~/.kube/config
    chmod 600 ~/.kube/config


    # --- 2. Extract Outputs from Terraform ---
- name: Get Terraform Outputs (all except for IOTHUB_DEVICE_CONNECTION_STRING)
  id: terraform_outputs
  run: |
    TERRAFORM_OUTPUTS=$(terraform output -json)

    # Output names must match usage later exactly (case-sensitive)
    echo "IOT_SIMULATOR_DEVICE_NAME=$(echo $TERRAFORM_OUTPUTS | jq -r '.iot_simulator_device_name.value')" >> $GITHUB_OUTPUT

    # NOTE: No base64 encoding here â€” Terraform already returns it encoded
    echo "AKS_KUBECFG=$(echo $TERRAFORM_OUTPUTS | jq -r '.aks_kube_config.value')" >> $GITHUB_OUTPUT

    echo "ACR_LOGIN_SERVER=$(echo $TERRAFORM_OUTPUTS | jq -r '.acr_login_server.value')" >> $GITHUB_OUTPUT
    echo "IOT_HUB_NAME=$(echo $TERRAFORM_OUTPUTS | jq -r '.iot_hub_name.value')" >> $GITHUB_OUTPUT
    echo "RESOURCE_GROUP_NAME=$(echo $TERRAFORM_OUTPUTS | jq -r '.resource_group_name.value')" >> $GITHUB_OUTPUT
  working-directory: ./terraform