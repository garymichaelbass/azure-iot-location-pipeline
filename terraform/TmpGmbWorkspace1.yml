# azure-iot-location-monitoring\terraform\aks.tf
# ... (rest of your AKS-related resources) ...

# Assign AcrPull to the AKS cluster's SYSTEM-ASSIGNED IDENTITY (control plane identity)
# This is the identity that AKS uses to pull images from ACR.
resource "azurerm_role_assignment" "aks_cluster_acr_pull_permission" {
  # The scope is your Azure Container Registry
  scope                = azurerm_container_registry.iot_acr.id

  # This is the built-in Azure role that grants permission to pull images from ACR.
  role_definition_name = "AcrPull"

  # Use the main cluster identity, NOT the kubelet identity.
  principal_id         = azurerm_kubernetes_cluster.iot_aks_cluster.identity[0].principal_id # <-- CORRECTED LINE

  # Explicit dependencies ensure ACR and AKS are created before attempting role assignment.
  depends_on = [
    azurerm_container_registry.iot_acr,
    azurerm_kubernetes_cluster.iot_aks_cluster
  ]
}

# You can keep your existing 'data "azurerm_container_registry" "iot_acr"' block if it's already there
# or replace it if your ACR is also created by Terraform in this config.